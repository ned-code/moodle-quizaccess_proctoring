define(["jquery","core/ajax","core/notification","core/modal_events","core/str","core/loglevel","core/config"],function(e,t,n,i,r,o,a){const c="quizaccess_proctoring",s="access_granted",l="quiz_start",d=864e5,u="height",g="width",m="id",p="cmid",f="courseid",h="enablescreenshare",v="faceidcheck",b="webcam_allowed",w="screen_allowed",y="face_allowed",k="checkbox_validation",_="final_deny",x="quizurl",j="id_start_quiz",z="allow_camera_btn",I="share_screen_btn",q="div.singlebutton.quizstartbuttondiv",D="monitor",S="is_quiz_page";let E=new o.constructor(c);E.originalFactory=E.methodFactory,E.methodFactory=((e,t)=>E.originalFactory(e,t).bind(E,"["+c+"]")),E.setLevel(E.getLevel());let A=E.debug.bind(E);A("loaded");let O={_storage:window.localStorage,_key:function(e){return e instanceof Array&&(e=e.join("_")),c+"_"+e.toString()},keyCheck:function(e,t){return e.toString()===this._key(t)},get:function(e){let t,n=this._storage.getItem(this._key(e));if("string"==typeof n)try{t=JSON.parse(n)}catch(e){t=n}else t=n;return t},remove:function(e){this._storage.removeItem(this._key(e))},set:function(e,t){let n;try{n=JSON.stringify(t)}catch(e){n=t}try{this._storage.setItem(this._key(e),n)}catch(e){return!1}return!0},isSupported:function(){if(!this._storage)return!1;try{let e="__storage_test__";this.set(e,e),this.remove(e)}catch(e){return!1}return!0}};O.isSupported()||ie("error:localStorage",null,!0);let C,B,L,T,M,N,R,U={},F=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(F=!0),U[g]=F?100:320,U[u]=0;let H=null;function V(e){return void 0===e}function J(e){for(const t in e)U[t]=e[t]}function W(){O.remove(s),O.remove(l)}function $(t=!1){A("finishAttempt","txt:",t);let n=function(){};U[S]?(O.remove(l),e("#page").remove(),n=oe):(W(),re(R)),t?("string"!=typeof t&&(t="warning:keepparentwindowopen"),ie(t,n)):n()}function G(e){let t=e.play();void 0!==t&&t.then(()=>{}).catch(()=>{})}function K(t,n=!1){if(U[S])return;if(U[_])return!1;let i=U[s],o=V(t)?function(){if(!U[S])return!(U[_]||!U[b]||U[h]&&!U[w]||U[v]&&!U[y]||!U[k])}():t;U[s]=o;let a=!o&&n;if(a){X(!1),Y(!1),U[_]=!0,e("#"+j).remove();let t=e(q);t.length&&(t.find("form").prop("action","").addClass("hidden").find(":input").prop("disabled",!0),r.get_string("cantattempt",c).done(n=>t.append(e("<div></div>").text(n).addClass("error"))))}return o!==i&&(O.set(s,!!o&&(new Date).getTime()),a||e("#"+j).prop("disabled",!o)),o}function P(){if(U[_])return;let e=function(){return X(!1),null};return L&&L.srcObject&&L.srcObject.active?void 0:e()}function Q(){if(U[_])return;let e=function(e=!1){return Y(!1,null,e),null};if(!T||!T.srcObject)return e();if(!T.srcObject.active)return e();let t=Z(T);return t!==D?V(t)?(ie("error:sharescreen",null,!0),e(!0)):(ie("warning:sorry:sharescreen"),e()):void 0}function X(t=!0,n=null){U[_]||(t=t&&L,U[b]=t,t?(n&&(L.srcObject=n),G(L)):L&&(L.srcObject&&L.srcObject.getTracks().forEach(e=>e.stop()),L.srcObject=null,L.removeAttribute("height"),L.streaming=!1),K(),e("#"+z).prop("disabled",t).toggleClass("disabled done",t))}function Y(t=!0,n=null,i=!1){U[_]||(t=t&&T&&!i,U[w]=t,t?(n&&(T.srcObject=n),G(T)):(T&&(T.srcObject&&T.srcObject.getTracks().forEach(e=>e.stop()),T.srcObject=null,T.removeAttribute("height")),re(R)),i?(K(!1,!0),e("#"+I).prop("disabled",!0).removeClass("done").addClass("disabled fail")):(K(),e("#"+I).prop("disabled",t).toggleClass("disabled done",t)),t&&Q())}function Z(e){let t=null;if(!e||!e.srcObject||!e.srcObject.getVideoTracks)return t;let n=e.srcObject.getVideoTracks();for(let e=0;e<n.length;e++){let i=n[e];if(!i.enabled||"video"!==i.kind)continue;let r=i.getSettings();if(r&&(t=r.displaySurface))return t}return t}function ee(){if(!U[b])return;let e=C.getContext("2d");e.fillStyle="#AAA",e.fillRect(0,0,C.width,C.height),H=C.toDataURL("image/png"),B&&B.setAttribute("src",H)}function te(){O.get(l)&&function(){if(null!==T.srcObject){let e=T.srcObject.active,i=Z(T);if(!e)return ie("warning:sorry:restartattempt"),clearInterval(N),R&&R.close(),!1;if(i!==D)return A(i),ie("warning:sorry:sharescreen"),clearInterval(N),R&&R.close(),!1;let r=document.getElementById("canvas-screen"),o=r.getContext("2d");r.width=screen.width,r.height=screen.height,o.drawImage(T,0,0,screen.width,screen.height);let a=r.toDataURL("image/png"),c={methodname:"quizaccess_proctoring_send_camshot",args:{courseid:U[f],screenshotid:U[m],cmid:U[p],webcampicture:a,imagetype:2}};t.call([c])[0].done(function(e){e.warnings.length<1||T&&(ie("error:takingimage",null,!0),clearInterval(N))}).fail(n.exception)}}()}function ne(){O.get(l)&&function(){let e=C.getContext("2d");if(U[g]&&U[u]){C.width=U[g],C.height=U[u],e.drawImage(L,0,0,U[g],U[u]),H=C.toDataURL("image/png"),B.setAttribute("src",H);let i={methodname:"quizaccess_proctoring_send_camshot",args:{courseid:U[f],screenshotid:U[m],cmid:U[p],webcampicture:H,imagetype:1}};t.call([i])[0].done(function(e){e.warnings.length<1||L&&ie("error:takingimage",null,!0)}).fail(n.exception)}else ee()}()}function ie(e,t=null,o=!1){r.get_strings([{key:o?"error":"warning"},{key:e,component:c},{key:"ok"}]).done(function(e){n.alert(e[0],e[1],e[2]).then(function(e){return t&&e.getRoot().on(i.hidden,()=>t()),e})}).fail(n.exception)}function re(e){e&&(e.close(),e.location&&e.location.assign&&e.location.assign("/mod/quiz/view.php?id="+U[p]))}function oe(e){re(e=e||window)}function ae(){const e=U[x];(function(){if(!function(){let e=O.get(s);return!!e&&e+d>=(new Date).getTime()}())return!0;if(null==window.opener||window.opener.closed)return!0;let t=window.opener.location.href;return!t.includes(e)||t!==e})()&&(A("call finishAttempt"),$(!1))}function ce(){L=document.getElementById("video"),C=document.getElementById("canvas"),B=document.getElementById("photo")}function se(t){"function"==typeof t&&("complete"===document.readyState?t():e(window).on("load",t))}let le={setup:function(t){return J(t),U[S]=!0,(null===document.getElementById("page-mod-quiz-summary")||!document.getElementById("page-mod-quiz-summary").innerHTML.length)&&((null===document.getElementById("page-mod-quiz-review")||!document.getElementById("page-mod-quiz-review").innerHTML.length)&&(O.set(l,!0),e("#mod_quiz_navblock").append('<div class="card-body p-3"><h3 class="no text-left">Webcam</h3><video id="video" class="navblock-video">Video stream not available.</video><canvas id="canvas" class="hidden"></canvas><div class="output hidden"><img id="photo" alt="The picture will appear in this box."/></div></div>'),ce(),le.videoStartup(()=>$("warning:sorry:restartattempt")),e(window).on("unload",$).on("storage",e=>{A("onstorage",e),e.key&&O.keyCheck(e.key,s)&&ae()}),se(function(){ae(),e("body").addClass("shown")}),!0))},videoStartup:function(e=null){if(U[_])return!1;let t=null;if(L){let n=function(...n){n&&A(...n),X(!1),ie("warning:cameraallowwarning"),t=!1,e&&"function"==typeof e&&e()};if(!navigator.mediaDevices)return n("No navigator.mediaDevices"),t;t=!0,navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(e=>X(!0,e)).catch(e=>n("navigator.mediaDevices.getUserMedia error",e)),L[c+"_init"]||(L.addEventListener("canplay",function(){L.streaming||(U[u]=L.videoHeight/(L.videoWidth/U[g]),isNaN(U[u])&&(U[u]=U[g]/(4/3)),L.setAttribute("width",U[g]),L.setAttribute("height",U[u]),C.setAttribute("width",U[g]),C.setAttribute("height",U[u]),L.streaming=!0)},!1),L.addEventListener("suspend",()=>P()),L.addEventListener("pause",()=>P()),L[c+"_init"]=!0)}else t=!1;return ee(),t},screenStartup:function(){if(U[_])return!1;let e=null,t=function(...t){t&&A(...t),Y(!1),ie("warning:sharescreen"),e=!1};if(!T)return e;if(!navigator.mediaDevices)return t("No navigator.mediaDevices"),!1;{e=!0;let n={video:{cursor:"always"},audio:!1};navigator.mediaDevices.getSupportedConstraints().displaySurface&&(n.video.displaySurface=D),navigator.mediaDevices.getDisplayMedia(n).then(e=>Y(!0,e)).catch(e=>t("navigator.mediaDevices.getDisplayMedia error",e))}return T[c+"_init"]||(T.addEventListener("suspend",()=>Q()),T.addEventListener("pause",()=>Q()),T[c+"_init"]=!0),e},setupBeforeAttempt:function(i){J(i),W(),K(!1);let r=e("#id_submitbutton");if(!r.length)return A("Error: no $submitbutton"),void K(!1,!0);r.prop("disabled",1),ce();let o=e('<button class="btn btn-primary"></button>').prop("id",j).prop("disabled",!0);return o.click(function(){if(event.preventDefault(),!K())return;let e=r.closest("form").prop("action")+"?cmid="+U[p]+"&sesskey="+a.sesskey;R=window.open(e,"_blank")}),o.text(r.text()||r.val()),r.after(o),e("#id_proctoring_checkbox").on("change",function(){U[k]=!!this.checked,K()}),se(()=>e(q).addClass("shown")),e("#"+z).click(function(e){e.preventDefault(),le.videoStartup()}),e("#id_cancel").click(function(){X(!1),Y(!1),U[y]=!1,e("#fcvalidate").removeClass("hidden"),e("#face_validation_result").html("")}),M=setInterval(ne,U.camshotdelay||1e3),e(window).on("unload",$),U[h]&&(T=document.getElementById("video-screen"),e("#"+I).click(function(e){e.preventDefault(),le.screenStartup()}),N=setInterval(te,U.camshotdelay||1e3)),U[v]&&e("#fcvalidate").click(function(){event.preventDefault(),U[y]=!1,C.getContext("2d").drawImage(L,0,0,C.width,C.height);let i=C.toDataURL("image/png");B.setAttribute("src",i);let r={methodname:"quizaccess_proctoring_validate_face",args:{courseid:U[f],cmid:U[p],webcampicture:i}};document.getElementById("loading_spinner").style.display="block",t.call([r])[0].done(function(t){U[y]=!1,t.warnings.length<1?(document.getElementById("loading_spinner").style.display="none","success"===t.status?(U[y]=!0,e(L).css("border","10px solid green"),e("#face_validation_result").html('<span style="color: green">True</span>'),e("#fcvalidate").addClass("hidden")):(e(L).css("border","10px solid red"),e("#face_validation_result").html('<span style="color: red">False</span>'))):(document.getElementById("loading_spinner").style.display="none",L&&ie("error:takingimage",null,!0)),K()}).fail(n.exception)}),!0}};return le});